name: app

type: 'golang:1.14'

hooks:
    build: |
        set -e
        MATTERMOST_VERSION=$(cat mattermost_version)
        echo "Downloading Mattermost ${MATTERMOST_VERSION}"
        wget --quiet -c https://releases.mattermost.com/${MATTERMOST_VERSION}/mattermost-${MATTERMOST_VERSION}-linux-amd64.tar.gz -O - | tar -xz
        cp -a mattermost/* .
        chmod +x bin/mattermost
        cp config/config.json config.default
    deploy: |
        if [ ! -f config/config.json ] || [ ! -s config/config.json ]; then
            cp config.default config/config.json
        fi
        ./bin/mmctl user create --local --username $PSH_INITADMIN_USERNAME --email $PSH_INITADMIN_EMAIL --password $PSH_INITADMIN_PASSWORD
        ./bin/mmctl team create --local --name $PSH_FIRSTTEAM_NAME --display-name $PSH_FIRSTTEAM_DISPLAYNAME --private
        ./bin/mmctl channel create --local --team $PSH_FIRSTTEAM_NAME --name $PSH_FIRSTCHANNEL_NAME --display-name $PSH_FIRSTCHANNEL_DISPLAYNAME
        ./bin/mmctl post create --local $PSH_FIRSTTEAM_NAME:$PSH_FIRSTCHANNEL_NAME --message $PSH_WELCOME_MESSAGE
        ./bin/mmctl post create --local $PSH_FIRSTTEAM_NAME:$PSH_FIRSTCHANNEL_NAME --message $PSH_WARNING_MESSAGE1
        ./bin/mmctl post create --local $PSH_FIRSTTEAM_NAME:$PSH_FIRSTCHANNEL_NAME --message $PSH_WARNING_MESSAGE2
relationships:
    database: "db:postgresql"
    essearch: "searchelastic:elasticsearch"

web:
    upstream:
        socket_family: tcp
        protocol: http
    commands:
        start: ./bin/mattermost
    locations:
        '/':
            root: 'client'
            index:
                - "root.html"
            allow: true
            rules:
                \.(css|js|gif|jpe?g|png|ttf|eot|woff2?|otf|html|ico|svg|map|json|woff?)$:
                    allow: true
                ^/robots\.txt$:
                    allow: true

disk: 1024

mounts:
    '/.config':
        source: local
        source_path: config-hidden
    'config':
        source: local
        source_path: config-files
    'logs':
        source: local
        source_path: log-files
    'data':
        source: local
        source_path: data-files
    'dist/files':
        source: local
        source_path: dist-files
    'plugins':
        source: local
        source_path: plugins
    'client/plugins':
        source: local
        source_path: client_plugins
